---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Section from '../../components/Section.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Get unique categories
const categories = [...new Set(sortedPosts.map((post) => post.data.category).filter(Boolean))];

// Calculate reading time (rough estimate)
function getReadingTime(content: string): number {
  const wordsPerMinute = 200;
  const words = content.split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}
---

<BaseLayout
  title="Blog | Kyle Cain"
  description="Articles on software development, tech strategy, and best practices"
>
  <Section
    title="Blog"
    subtitle="Thoughts on software development, tech strategy, and best practices"
    class="pt-24"
  >
    <!-- Category Filter -->
    {categories.length > 0 && (
      <div class="mb-6 sm:mb-8 flex flex-wrap gap-2" id="category-filter">
        <button
          class="filter-btn active px-4 py-2 text-sm rounded-lg border border-border hover:border-primary/50 transition-colors min-h-[44px]"
          data-category="all"
        >
          All
        </button>
        {categories.map((cat) => (
          <button
            class="filter-btn px-4 py-2 text-sm rounded-lg border border-border text-text-secondary hover:border-primary/50 hover:text-text-primary transition-colors min-h-[44px]"
            data-category={cat}
          >
            {cat}
          </button>
        ))}
      </div>
    )}

    <!-- Blog Posts Grid -->
    {sortedPosts.length > 0 ? (
      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6" id="posts-grid">
        {sortedPosts.map((post, index) => (
          <div
            class="post-item animate-on-scroll"
            data-category={post.data.category || 'uncategorized'}
            style={`animation-delay: ${index * 0.1}s`}
          >
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              slug={post.id.replace(/\.md$/, '')}
              date={post.data.date}
              image={post.data.image}
              category={post.data.category}
            />
          </div>
        ))}
      </div>
    ) : (
      <p class="text-text-secondary text-center py-12">
        No posts yet. Check back soon!
      </p>
    )}
  </Section>
</BaseLayout>

<script>
  const filterBtns = document.querySelectorAll('.filter-btn');
  const postItems = document.querySelectorAll('.post-item');

  filterBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const category = btn.getAttribute('data-category');

      // Update active button
      filterBtns.forEach((b) => {
        b.classList.remove('active', 'bg-primary/10', 'text-primary', 'border-primary/50');
        b.classList.add('text-text-secondary');
      });
      btn.classList.add('active', 'bg-primary/10', 'text-primary', 'border-primary/50');
      btn.classList.remove('text-text-secondary');

      // Filter posts
      postItems.forEach((item) => {
        const itemCat = item.getAttribute('data-category');
        if (category === 'all' || itemCat === category) {
          (item as HTMLElement).style.display = 'block';
        } else {
          (item as HTMLElement).style.display = 'none';
        }
      });
    });
  });

  // Set initial active state
  document.querySelector('.filter-btn[data-category="all"]')?.classList.add('bg-primary/10', 'text-primary', 'border-primary/50');
</script>

<style>
  .filter-btn.active {
    @apply bg-primary/10 text-primary border-primary/50;
  }
</style>
