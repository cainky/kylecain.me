---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.id.replace(/\.md$/, '') },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Calculate reading time from raw content
const words = post.body?.split(/\s+/).length || 0;
const readingTime = Math.max(1, Math.ceil(words / 200));
---

<BaseLayout
  title={`${post.data.title} | Kyle Cain`}
  description={post.data.description}
  image={post.data.image}
>
  <!-- Reading Progress Bar -->
  <div id="progress-bar" class="fixed top-16 left-0 right-0 h-1 bg-border z-40">
    <div id="progress-fill" class="h-full bg-gradient-to-r from-primary to-secondary w-0 transition-all duration-150"></div>
  </div>

  <article class="pt-24 pb-16">
    <!-- Hero Header -->
    <header class="max-w-4xl mx-auto px-4 sm:px-6 mb-12 sm:mb-16">
      <div class="flex flex-wrap items-center gap-3 mb-6 text-sm">
        {post.data.category && (
          <span class="px-3 py-1.5 bg-primary/10 text-primary rounded-full font-medium">
            {post.data.category}
          </span>
        )}
        <span class="text-text-secondary">
          {formattedDate}
        </span>
        <span class="text-text-secondary/50">â€¢</span>
        <span class="text-text-secondary">
          {readingTime} min read
        </span>
      </div>

      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-text-primary mb-6 leading-tight">
        {post.data.title}
      </h1>

      <p class="text-lg sm:text-xl text-text-secondary leading-relaxed max-w-3xl">
        {post.data.description}
      </p>
    </header>

    <!-- Cover Image -->
    {post.data.image && (
      <div class="max-w-4xl mx-auto px-4 sm:px-6 mb-12 sm:mb-16">
        <div class="relative rounded-2xl overflow-hidden shadow-2xl shadow-primary/10">
          <img
            src={post.data.image}
            alt={post.data.title}
            class="w-full h-auto max-h-[400px] object-cover"
          />
          <div class="absolute inset-0 rounded-2xl ring-1 ring-inset ring-white/10"></div>
        </div>
      </div>
    )}

    <!-- Main Content Area with Sidebar TOC -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="lg:grid lg:grid-cols-[1fr_280px] lg:gap-12">
        <!-- Article Content -->
        <div class="max-w-[720px]">
          <!-- Mobile TOC -->
          {headings.length > 2 && (
            <nav class="lg:hidden mb-10 p-5 bg-surface/50 backdrop-blur rounded-xl border border-border">
              <h2 class="text-sm font-semibold text-text-primary mb-4 uppercase tracking-wide">In this article</h2>
              <ul class="space-y-2">
                {headings
                  .filter((h) => h.depth <= 3)
                  .map((heading) => (
                    <li style={`padding-left: ${(heading.depth - 2) * 0.75}rem`}>
                      <a
                        href={`#${heading.slug}`}
                        class="text-text-secondary hover:text-primary transition-colors text-sm block py-1"
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))}
              </ul>
            </nav>
          )}

          <!-- Content -->
          <div class="prose">
            <Content />
          </div>

          <!-- Tags -->
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="mt-16 pt-8 border-t border-border">
              <div class="flex flex-wrap gap-2">
                {post.data.tags.map((tag) => (
                  <span class="px-4 py-2 text-sm bg-surface border border-border rounded-full text-text-secondary hover:border-primary/50 hover:text-primary transition-colors cursor-default">
                    #{tag}
                  </span>
                ))}
              </div>
            </div>
          )}

          <!-- Back to Blog -->
          <div class="mt-12 pt-8 border-t border-border">
            <a
              href="/blog"
              class="group inline-flex items-center gap-2 text-text-secondary hover:text-primary transition-colors"
            >
              <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              <span>Back to all articles</span>
            </a>
          </div>
        </div>

        <!-- Sticky Sidebar TOC (Desktop) -->
        {headings.length > 2 && (
          <aside class="hidden lg:block">
            <div class="sticky top-24">
              <nav class="p-5 bg-surface/30 backdrop-blur-sm rounded-xl border border-border/50">
                <h2 class="text-xs font-semibold text-text-secondary mb-4 uppercase tracking-wider">On this page</h2>
                <ul class="space-y-1" id="toc-links">
                  {headings
                    .filter((h) => h.depth <= 3)
                    .map((heading) => (
                      <li>
                        <a
                          href={`#${heading.slug}`}
                          data-heading={heading.slug}
                          class={`toc-link block py-1.5 text-sm transition-colors border-l-2 ${
                            heading.depth === 2
                              ? 'pl-3 border-transparent text-text-secondary hover:text-text-primary hover:border-primary/50'
                              : 'pl-6 border-transparent text-text-secondary/70 hover:text-text-secondary hover:border-primary/30'
                          }`}
                        >
                          {heading.text}
                        </a>
                      </li>
                    ))}
                </ul>
              </nav>

              <!-- Scroll to top -->
              <button
                id="scroll-top"
                class="mt-4 w-full py-3 px-4 bg-surface/50 border border-border/50 rounded-xl text-sm text-text-secondary hover:text-primary hover:border-primary/50 transition-all flex items-center justify-center gap-2 opacity-0 translate-y-2"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                </svg>
                Back to top
              </button>
            </div>
          </aside>
        )}
      </div>
    </div>
  </article>
</BaseLayout>

<script>
  // Reading progress bar
  const progressFill = document.getElementById('progress-fill');
  const article = document.querySelector('article');

  function updateProgress() {
    if (!article || !progressFill) return;
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrollY = window.scrollY;

    const progress = Math.min(100, Math.max(0,
      ((scrollY - articleTop + windowHeight * 0.3) / (articleHeight - windowHeight * 0.5)) * 100
    ));

    progressFill.style.width = `${progress}%`;
  }

  // Active TOC highlighting
  const tocLinks = document.querySelectorAll('.toc-link');
  const headings = document.querySelectorAll('article h2, article h3');

  function updateActiveTOC() {
    let currentHeading = '';

    headings.forEach((heading) => {
      const rect = heading.getBoundingClientRect();
      if (rect.top <= 120) {
        currentHeading = heading.id;
      }
    });

    tocLinks.forEach((link) => {
      const href = link.getAttribute('href')?.slice(1);
      if (href === currentHeading) {
        link.classList.add('text-primary', 'border-primary');
        link.classList.remove('text-text-secondary', 'text-text-secondary/70', 'border-transparent');
      } else {
        link.classList.remove('text-primary', 'border-primary');
        if (link.classList.contains('pl-6')) {
          link.classList.add('text-text-secondary/70', 'border-transparent');
        } else {
          link.classList.add('text-text-secondary', 'border-transparent');
        }
      }
    });
  }

  // Scroll to top button
  const scrollTopBtn = document.getElementById('scroll-top');

  function updateScrollTopBtn() {
    if (!scrollTopBtn) return;
    if (window.scrollY > 500) {
      scrollTopBtn.classList.remove('opacity-0', 'translate-y-2');
      scrollTopBtn.classList.add('opacity-100', 'translate-y-0');
    } else {
      scrollTopBtn.classList.add('opacity-0', 'translate-y-2');
      scrollTopBtn.classList.remove('opacity-100', 'translate-y-0');
    }
  }

  scrollTopBtn?.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Smooth scroll for TOC links
  tocLinks.forEach((link) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const href = link.getAttribute('href');
      if (href) {
        const target = document.querySelector(href);
        if (target) {
          const top = target.getBoundingClientRect().top + window.scrollY - 100;
          window.scrollTo({ top, behavior: 'smooth' });
        }
      }
    });
  });

  // Event listeners
  window.addEventListener('scroll', () => {
    updateProgress();
    updateActiveTOC();
    updateScrollTopBtn();
  }, { passive: true });

  // Initial calls
  updateProgress();
  updateActiveTOC();
  updateScrollTopBtn();
</script>

<style is:global>
  /* Enhanced Prose Styling */
  .prose {
    @apply text-text-primary;
    font-size: 1.1875rem;
    line-height: 1.85;
    letter-spacing: 0.01em;
  }

  .prose > * + * {
    margin-top: 1.5em;
  }

  .prose h2 {
    @apply text-2xl sm:text-3xl font-bold mt-16 mb-6 text-text-primary;
    letter-spacing: -0.02em;
    scroll-margin-top: 100px;
  }

  .prose h3 {
    @apply text-xl sm:text-2xl font-semibold mt-12 mb-5 text-text-primary;
    letter-spacing: -0.01em;
    scroll-margin-top: 100px;
  }

  .prose h4 {
    @apply text-lg font-medium mt-10 mb-4 text-text-primary;
    scroll-margin-top: 100px;
  }

  .prose p {
    @apply text-gray-200;
  }

  .prose a {
    @apply text-primary hover:text-primary/80 underline decoration-primary/30 underline-offset-2 hover:decoration-primary/60 transition-colors;
  }

  .prose strong {
    @apply text-text-primary font-semibold;
  }

  .prose em {
    @apply text-text-primary/90;
  }

  /* Lists */
  .prose ul,
  .prose ol {
    @apply pl-6 text-gray-200;
  }

  .prose ul {
    @apply list-disc;
  }

  .prose ol {
    @apply list-decimal;
  }

  .prose li {
    @apply mb-4 pl-3;
    line-height: 1.8;
  }

  .prose li::marker {
    @apply text-primary/70;
  }

  /* Blockquotes */
  .prose blockquote {
    @apply border-l-4 border-primary/50 pl-6 py-4 my-10 bg-primary/5 rounded-r-lg;
  }

  .prose blockquote p {
    @apply text-text-primary/90 italic text-lg leading-relaxed;
  }

  /* Code */
  .prose pre {
    @apply bg-[#0d1117] border border-border/50 rounded-xl p-5 overflow-x-auto my-8;
    font-size: 0.875rem;
  }

  .prose code {
    @apply font-mono;
  }

  .prose :not(pre) > code {
    @apply bg-surface px-2 py-1 rounded-md text-secondary text-sm font-medium;
  }

  /* Images */
  .prose img {
    @apply rounded-xl my-10 shadow-lg;
  }

  /* Horizontal Rule */
  .prose hr {
    @apply border-0 h-px bg-gradient-to-r from-transparent via-border to-transparent my-20;
  }

  /* Tables */
  .prose table {
    @apply w-full my-10 text-base;
  }

  .prose thead {
    @apply border-b border-border;
  }

  .prose th {
    @apply text-left py-4 px-4 font-semibold text-text-primary;
  }

  .prose td {
    @apply py-4 px-4 text-gray-200 border-b border-border/50;
  }

  .prose tbody tr:hover {
    @apply bg-surface/50;
  }

  /* Selection */
  .prose ::selection {
    @apply bg-primary/30 text-white;
  }
</style>
